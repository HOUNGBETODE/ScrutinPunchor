from config import MHR
from json2table import convert
from controllers.utils import notify
import base64, filehash, os, requests, time


def computeHash(path):
    return filehash.FileHash().hash_file(path)


def analysis(FILE_PATH):
    diagnosis = None
    mhr_api_infos = MHR.load()
    sha256hash = computeHash(FILE_PATH)
    basic_auth_key = base64.b64encode(f"{mhr_api_infos['username']}:{mhr_api_infos['password']}".encode()).decode()

    session = requests.Session()
    url = f"{mhr_api_infos['base-api-url']}/{sha256hash}"
    session.headers = {"Authorization": f"Basic {basic_auth_key}"}

    hash_analysis_results = session.get(url, verify=False).json()
    session.close()

    av_hits = hash_analysis_results["antivirus_detection_rate"]
    if av_hits:
        diagnosis = f"""<b>**** MALWARE HASH REGISTRY ENGINE RESULTS ***</b><br/>Below is the MHR analysis results : {convert(hash_analysis_results)}"""
    
    return diagnosis